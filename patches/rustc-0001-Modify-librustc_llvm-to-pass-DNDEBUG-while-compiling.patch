From c41bffe7faf353906bf75835af92d07f43417820 Mon Sep 17 00:00:00 2001
From: Joel Galenson <jgalenson@google.com>
Date: Wed, 17 Jul 2019 08:17:49 -0700
Subject: [PATCH] Modify librustc_llvm to pass -DNDEBUG while compiling.

Currently, librustc_llvm builds are not reproducible because the LLVM
files it compiles use the debug version of llvm_unreachable, which
uses __FILE__.  To fix this, we propagate NDEBUG from bootstrap if
applicable and use it when compiling librustc_llvm.
---
 src/bootstrap/compile.rs   | 3 +++
 src/librustc_llvm/build.rs | 5 +++++
 2 files changed, 8 insertions(+)

diff --git a/src/bootstrap/compile.rs b/src/bootstrap/compile.rs
index e1cdd226fd..83d0e3fcd7 100644
--- a/src/bootstrap/compile.rs
+++ b/src/bootstrap/compile.rs
@@ -768,6 +768,9 @@ pub fn build_codegen_backend(builder: &Builder<'_>,
             if builder.config.llvm_use_libcxx {
                 cargo.env("LLVM_USE_LIBCXX", "1");
             }
+            if builder.config.llvm_optimize && !builder.config.llvm_release_debuginfo {
+                cargo.env("LLVM_NDEBUG", "1");
+            }
         }
         _ => panic!("unknown backend: {}", backend),
     }
diff --git a/src/librustc_llvm/build.rs b/src/librustc_llvm/build.rs
index 7fa83dd977..0ae0cb1194 100644
--- a/src/librustc_llvm/build.rs
+++ b/src/librustc_llvm/build.rs
@@ -154,6 +154,11 @@ fn main() {
         cfg.define("LLVM_RUSTLLVM", None);
     }
 
+    println!("cargo:rerun-if-changed-env=LLVM_NDEBUG");
+    if env::var_os("LLVM_NDEBUG").is_some() {
+        cfg.define("NDEBUG", None);
+    }
+
     build_helper::rerun_if_changed_anything_in_dir(Path::new("../rustllvm"));
     cfg.file("../rustllvm/PassWrapper.cpp")
        .file("../rustllvm/RustWrapper.cpp")
-- 
2.22.0.510.g264f2c817a-goog

